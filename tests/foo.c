
// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

// ====================================

// gcc T.c foo.c -lpthread -o foo
// g++ T.c foo.c -lpthread -o foo -Wno-deprecated

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#include "T.h"

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#include <unistd.h>

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

int main()
{
    return (ttt_testAll() != TTT_GOOD);
}

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

static int fooCounter = 0;

void *threadedTest (void *x)
{
    int i, threadNumber = (int)(long)x + 1;             /* The thread number is passed as argument. */
    TTTWaste w;
    
    ttt_stdout (TTT_COLOR_NONE, "### %d / %d", threadNumber, ttt_testThreadsNumber());
    
    ttt_wasteInit (&w, threadNumber);
    
    for (i = 0; i < 1000000; i++) {
    //
    if (threadNumber == 1) { fooCounter++; }
    if (threadNumber == 2) { fooCounter--; }
    ttt_wasteTime (&w);
    //
    }
    
    return NULL;
}

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

TTT_BEGIN (Foo, 0, NULL)                                /* First argument must be unique. */

TTT_EXPECT (0 + 0 == 0);

TTT_END

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

TTT_BEGIN (FooPrologue, -1, "Prologue")                 /* Order is set with the second argument. */

TTT_FAIL

TTT_END

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

TTT_BEGIN_ALLOW (FooThread, 1, "Thread")                /* Allowed to fail. */

ttt_testThreadsLaunch (threadedTest);                   /* Launch one thread per CPU. */
TTT_EXPECT (fooCounter == 0);                           /* Fails on multi-core machines (at least on mine)! */

TTT_END

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

TTT_BEGIN (FooTime, 2, "Time")

ttt_timeTrigger();
sleep (1);
ttt_stdout (TTT_COLOR_BLUE, "%f", ttt_timeTrigger());   /* Measure time spent in milliseconds. */

TTT_END

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
