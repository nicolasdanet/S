
/* Copyright (c) 2021 Jojo and others. */

/* < https://opensource.org/licenses/BSD-3-Clause > */

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

namespace spaghettis {

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

class Patches {

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

public:
    Patches()  = default;
    ~Patches() = default;

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

public:
    void addObject (const core::Unique& u, const core::Description& v)
    {
        jassert (u.isValid());

        if (u.isRoot()) { createPatch (u, v); }
        else {
            perform (u, [&] (Patch *p) { p->addObject (u, v); });
        }
    }

    void removeObject (const core::Unique& u)
    {
        jassert (u.isValid());

        if (u.isRoot()) { closePatch (u, false); }
        else {
            perform (u, [&] (Patch *p) { p->removeObject (u); });
        }
    }

    void renameObject (const core::Unique& u, core::Unique::Identifier i)
    {
        jassert (u.isValid());
    }

    void changeObject (const core::Unique& u, const core::Description& v)
    {
        jassert (u.isValid());
    }
    
// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

public:
    void closeAllPatches();
    
// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

private:
    void createPatch (const core::Unique& u, const core::Description& v);
    void closePatch (const core::Unique& u, bool notify = true);
    
private:
    std::shared_ptr<Patch> fetchPatch (const core::Unique& u) const;
    void removePatch (const core::Unique& u);
    
// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

private:
    static auto isEqual (const core::Unique& u)
    {
        return [i = u.getRoot()] (const auto& p) { return (p->getUnique().getIdentifier() == i); };
    }
    
    static auto getUnique()
    {
        return [](const auto& p) { return p->getUnique(); };
    }
    
// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

private:
    template <class T> void perform (const core::Unique& u, T f) const
    {
        auto r = std::find_if (roots_.cbegin(), roots_.cend(), Patches::isEqual (u));
    
        if (r != roots_.cend()) { f (r->get()); }
    }

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

private:
    std::vector<std::shared_ptr<Patch>> roots_;

private:
    JUCE_DECLARE_NON_COPYABLE_WITH_LEAK_DETECTOR (Patches)
};

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

} // namespace spaghettis

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

