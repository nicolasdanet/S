
/* < https://opensource.org/licenses/BSD-3-Clause > */

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

/* < https://github.com/mintomic/mintomic/tree/master/tests > */

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#if PD_64BIT

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

static int test_pointerFailed;

static t_pointerAtomic  test_pointerShared;

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

#define TEST_POINTER_LOOP   10000000

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

void *test_pointer (void *x)
{
    int i, n = (int)(long)x;
    
    TTTWaste w;
    
    ttt_wasteInit (&w, n);
    
    if ((n % 2) == 0) {
    
        t_rand48 seed;
        
        PD_RAND48_INIT (seed);
        
        for (i = 0; i < TEST_POINTER_LOOP; i++) {
        //
        int k = (int)(PD_RAND48_DOUBLE (seed) * 8);
        
        PD_ATOMIC_POINTER_WRITE (test_uInt64Values[k], &test_pointerShared);
        
        PD_MEMORY_BARRIER;      /* Prevent hoisting the store out of the loop. */
        
        ttt_wasteTime (&w);
        //
        }

    } else {
    
        for (i = 0; i < TEST_POINTER_LOOP; i++) {
        //
        PD_MEMORY_BARRIER;      /* Prevent hoisting the load out of the loop. */
        
        void *t = PD_ATOMIC_POINTER_READ (&test_pointerShared);
        
        if (((uint64_t)t * (uint64_t)t) < test_uInt64Limit) { test_pointerFailed = 1; }
        
        ttt_wasteTime (&w);
        //
        }
    }

    return NULL;
}

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#if 0
void test14__pointer() {    /* Read / Write. */
#endif

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

TTT_BEGIN (AtomicPointer, 14, "Atomic - Pointer")

    TTT_EXPECT (sizeof (t_pointerAtomic) == 8);
    
    PD_ATOMIC_POINTER_WRITE (test_uInt64Values[0], &test_pointerShared);
    
    if (ttt_testThreadsLaunch (test_pointer) != TTT_GOOD) { TTT_FAIL; }
    else {
       TTT_EXPECT (test_pointerFailed == 0);
    }

TTT_END

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#if 0
}
#endif

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#endif // PD_64BIT

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
