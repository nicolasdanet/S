#! /usr/bin/env bash

# ------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------

# Must be executed at the same level.

rep=$(pwd); [ "${0%/*}" = "." ] || exit 1

# ------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------

CPUFLAGS="-march=native"

export CPUFLAGS

# ------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------

# Basic platform handler.

case "$OSTYPE" in
    darwin*)    receipe="makefile.mac" ;;
    linux*)     receipe="makefile.linux" ;;
    *)          exit 1 ;;
esac

# ------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------

# Build and copy the executable.

echo "Build spaghettis ..."

from="${rep}/bin/spaghettis"
dest="${rep}/spaghettis"

make -f "${receipe}"                                                                || exit 1
cp "${from}" "${dest}"                                                              || exit 1
[[ -e "${from}.dSym" ]] && cp -R "${from}.dSym" "${dest}.dSym"
make -f "${receipe}" clean                                                          || exit 1

# ------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------

# Build the test suite.

echo "Build tests ..."

g++ -std=c++11 main.cpp -O3 -ffast-math ${CPUFLAGS} -ldl -lpthread -lm -o tests     || exit 1

# ------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------

echo "SUCCEEDED"

# ------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------
