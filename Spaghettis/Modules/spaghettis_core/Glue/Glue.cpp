
/* Copyright (c) 2021 Nicolas Danet. */

/* < https://opensource.org/licenses/BSD-3-Clause > */

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

namespace spaghettis {

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

namespace core {

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

extern int  main_argc;

extern char **main_argv;

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

Wrapper *main_wrapper;

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

void main_threadLoopFakeCommandLine (const juce::StringArray& cmd)
{
    int n = cmd.size();
    
    if (n) {
    //
    main_argc = n;
    main_argv = static_cast<char**> (spaghettis_memoryGet (sizeof (char*) * n));
    
    for (int i = 0; i < n; ++i) {
        const juce::String& s = cmd[i];
        const size_t size = s.getNumBytesAsUTF8() + 1;
        main_argv[i] = static_cast <char*> (spaghettis_memoryGet (size));
        s.copyToUTF8 (main_argv[i], size);
    }
    //
    } else { jassertfalse; }
}

void main_threadLoopFakeCommandLineRelease()
{
    for (int i = 0; i < main_argc; ++i) { spaghettis_memoryFree (main_argv[i]); }
    
    spaghettis_memoryFree (main_argv);
}

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

bool main_threadLoop (Wrapper *owner)
{
    main_wrapper = owner;

    main_threadLoopFakeCommandLine (main_wrapper->getCommandLine());
    
    // int error = main_start();
    
    main_threadLoopFakeCommandLineRelease();
    
    // return (error != 0);
    
    return true;
}

void main_threadExit()
{
    main_exit();
}

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

} // namespace core

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

} // namespace spaghettis

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
