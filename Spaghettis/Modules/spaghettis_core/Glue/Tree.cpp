
/* Copyright (c) 2022 Jojo and others. */

/* < https://opensource.org/licenses/BSD-3-Clause > */

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

namespace spaghettis {

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

namespace core {

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

juce::var Tree::getValue (const juce::String& group, const juce::String& key) const
{
    return getGroup (group).getParameter (key).getValue();
}
    
// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

Group Tree::addGroup (const juce::String& name)
{
    jassert (!hasGroup (name));
    
    juce::ValueTree group (Ids::GROUP); group.setProperty (Ids::name, name, nullptr);
        
    tree_.appendChild (group, nullptr);
        
    return Group (group);
}

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

bool Tree::hasGroup (const juce::String& group) const
{
    return getGroup (group).isValid();
}

Group Tree::getGroup (const juce::String& name) const
{
    for (const auto& group : *this) { if (group.getName() == name) { return group; } }
    
    return Group();
}

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

namespace {

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

void setValueOfParameter (core::Tree& tree,
    const juce::String& group,
    const juce::String& key,
    const juce::var& v)
{
    if (tree.getGroup (group).hasParameter (key)) {
        tree.getGroup (group).getParameter (key).setValue (v);
    }
}

bool isValidTree (const Tree& other)
{
    for (const auto& group : other) {
        if (!group.isValid()) { return false; }
    }

    return true;
}

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

}

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

void Tree::setParametersFrom (const juce::ValueTree& tree)
{
    if (tree.isValid() && tree.hasType (tree_.getType())) {
    //
    const Tree other (tree);
    
    if (isValidTree (other)) {
    //
    for (const auto& group : other) {
        const juce::String name (group.getName());
        for (const auto& parameter : group) {
            setValueOfParameter (*this, name, parameter.getKey(), parameter.getValue());
        }
    }
    //
    }
    //
    }
}

void Tree::write (const juce::File& file) const
{
    std::unique_ptr<juce::XmlElement> xml (tree_.createXml());
    
    if (xml) { xml->writeTo (file); }
}

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

} // namespace core

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

} // namespace spaghettis

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
