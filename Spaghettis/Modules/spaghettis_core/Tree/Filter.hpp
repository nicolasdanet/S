
/* Copyright (c) 2022 Jojo and others. */

/* < https://opensource.org/licenses/BSD-3-Clause > */

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

namespace spaghettis {

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

namespace core {

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

class FilterBase : public juce::Value::ValueSource, private juce::Value::Listener {

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

protected:
    explicit FilterBase (const juce::Value& origin) : origin_ (origin)
    {
        origin_.addListener (this);
    }

    ~FilterBase() = default;

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

public:
    juce::String getType (const juce::var& v)
    {
        if (v.isInt())      { return juce::String ("isInt");    }
        if (v.isInt64())    { return juce::String ("isInt64");  }
        if (v.isBool())     { return juce::String ("isBool");   }
        if (v.isDouble())   { return juce::String ("isDouble"); }
        if (v.isString())   { return juce::String ("isString"); }
        
        return juce::String ("undefined");
    }

protected:
    void setValueProceed (const juce::var& newValue)
    {
        const juce::var oldValue (origin_.getValue());
                
        DBG (newValue.toString() + " -> " + oldValue.toString());
        DBG (getType (newValue) + " -> " + getType (oldValue));
        
        if (!newValue.equals (oldValue)) {
            DBG ("!");
            origin_ = newValue;
            sendChangeMessage (false);
        }
    }
    
private:
    juce::var getValue() const override
    {
        return origin_.getValue();
    }

    void valueChanged (juce::Value&) override
    {
        sendChangeMessage (true);
    }

private:
    juce::Value origin_;

private:
    JUCE_DECLARE_NON_COPYABLE_WITH_LEAK_DETECTOR (FilterBase)
};

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

template <class T> class Filter : FilterBase {

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

public:
    explicit Filter (const juce::Value& origin) : FilterBase (origin)
    {
    }

    ~Filter() = default;

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

public:
    void setValue (const juce::var& newValue) override
    {
        setValueProceed (juce::var (static_cast<T> (newValue)));
    }

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

public:
    static juce::Value make (const juce::Value& value)
    {
        return juce::Value (new Filter<T> (value));
    }

private:
    JUCE_DECLARE_NON_COPYABLE_WITH_LEAK_DETECTOR (Filter)
};

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

} // namespace core

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

} // namespace spaghettis

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
