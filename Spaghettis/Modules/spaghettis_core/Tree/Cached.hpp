
/* Copyright (c) 2022 Jojo and others. */

/* < https://opensource.org/licenses/BSD-3-Clause > */

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

namespace spaghettis {

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

namespace core {

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

template <class T> class Cached : private juce::Value::Listener {

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

private:
    Cached (const core::Tree& tree, const juce::String& group, const juce::String& key) :
        value_ (tree.getParameter (group, key).getValueSource())
    {
        value_.addListener (this);
    }

public:
    ~Cached() = default;

public:
    Cached (Cached&&) = default;
    Cached& operator = (Cached&&) = default;
    
public:
    Cached (const Cached&) = delete;
    Cached& operator = (const Cached&) = delete;

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

public:
    T get() const
    {
        return juce::VariantConverter<T>::fromVar (value_.getValue());
    }
    
// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

private:
    void valueChanged (juce::Value& value) override
    {
        DBG ("?");
    }

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

public:
    static Cached make (const core::Tree& tree, const juce::String& group, const juce::String& key)
    {
        jassert (tree.getParameter (group, key).getType() == ParameterType<T>::get());

        return Cached (tree, group, key);
    }
    
private:
    juce::Value value_;
};

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

} // namespace core

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

} // namespace spaghettis

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

