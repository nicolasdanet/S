
/* Copyright (c) 2021 Nicolas Danet. */

/* < https://opensource.org/licenses/BSD-3-Clause > */

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

namespace spaghettis {

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

class MessageQueues {

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

using FunctorsContainer = std::vector<std::function<void()>>;

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

public:
    MessageQueues()
    {
    }
    
    ~MessageQueues()
    {
        jassert (inputs_.empty());
    }
    
// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

public:
    void addInput (std::function<void()> f)
    {
        const juce::ScopedLock lock (lock_); inputs_.push_back (std::move (f));
    }

    void clear()
    {
        pollInputsProceed (true);
    }

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

private:
    void pollInputsProceed (bool fake)
    {
        FunctorsContainer scoped;
        
        {
            const juce::ScopedLock lock (lock_); scoped.swap (inputs_);
        }
        
        if (!fake) { for (auto f : scoped) { f(); } }
    }

public:
    void pollInputs (bool fake = false)
    {
        bool hasSometing = 0;
        
        {
            const juce::ScopedLock lock (lock_); hasSometing = (inputs_.empty() == false);
        }
        
        if (hasSometing) { pollInputsProceed (fake); }
    }
    
// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

private:
    FunctorsContainer inputs_;
    juce::CriticalSection lock_;

private:
    JUCE_DECLARE_NON_COPYABLE_WITH_LEAK_DETECTOR (MessageQueues)
    
// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

};

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

} // namespace spaghettis

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
