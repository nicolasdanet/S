
/* Copyright (c) 2021 Nicolas Danet. */

/* < https://opensource.org/licenses/BSD-3-Clause > */

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

namespace spaghettis {

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

using Perform = std::function<void()>;

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

class Queues : private juce::AsyncUpdater {

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

public:
    explicit Queues()
    {
    }
    
    ~Queues() override
    {
        jassert (inputs_.empty());
        jassert (outputs_.empty());
    }
    
// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

public:
    void addInput (const Perform& f)
    {
        add (inputs_, lockInputs_, f);
    }

    void addOutput (const Perform& f)
    {
        add (outputs_, lockOutputs_, f); triggerAsyncUpdate();
    }

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

public:
    void clear()
    {
        poll (inputs_,  lockInputs_,  true);
        poll (outputs_, lockOutputs_, true);
    }

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

public:
    void pollInputs()
    {
        poll (inputs_, lockInputs_, false);
    }

private:
    void handleAsyncUpdate() override
    {
        poll (outputs_, lockOutputs_, false);
    }
    
// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

private:
    void poll (std::vector<Perform>& c, std::mutex& lock, bool fake)
    {
        std::vector<Perform> scoped;
        
        {
            const std::lock_guard<std::mutex> l (lock); scoped.swap (c);
        }
        
        if (!fake) { for (auto f : scoped) { f(); } }
    }
    
    void add (std::vector<Perform>& c, std::mutex& lock, Perform f)
    {
        const std::lock_guard<std::mutex> l (lock); c.push_back (std::move (f));
    }
    
// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

private:
    std::vector<Perform> inputs_;
    std::mutex lockInputs_;

private:
    std::vector<Perform> outputs_;
    std::mutex lockOutputs_;
    
private:
    JUCE_DECLARE_NON_COPYABLE_WITH_LEAK_DETECTOR (Queues)
    
// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

};

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

} // namespace spaghettis

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
