
/* Copyright (c) 1997-2020 Miller Puckette and others. */

/* < https://opensource.org/licenses/BSD-3-Clause > */

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#include "../../m_spaghettis.h"
#include "../../m_core.h"

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

#define POLLING_PERIOD  47.0

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

PD_LOCAL void startup_openPendedFiles (void);

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

static void instance_pollingTask (void *dummy)
{
    if (symbol_hasThingQuiet (sym__polling)) {
        pd_message (symbol_getThing (sym__polling), sym__polling, 0, NULL);
    }  
    
    instance_get()->pd_pollingCount++;
    
    if (instance_get()->pd_pollingCount == 10) {
        startup_openPendedFiles();
    }

    clock_delay (instance_get()->pd_polling, POLLING_PERIOD);
}

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

PD_LOCAL void instance_pollingRun (void)
{
    instance_get()->pd_polling = clock_new ((void *)NULL, (t_method)instance_pollingTask);
    clock_delay (instance_get()->pd_polling, POLLING_PERIOD);
}

PD_LOCAL void instance_pollingStop (void)
{
    clock_free (instance_get()->pd_polling);
    instance_get()->pd_polling = NULL;
}

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

PD_LOCAL void instance_pollingRegister (t_pd *x)
{
    pd_bind (x, sym__polling);
}

PD_LOCAL void instance_pollingUnregister (t_pd *x)
{
    pd_unbind (x, sym__polling);
}

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
