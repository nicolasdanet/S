
/* Copyright (c) 1997 Miller Puckette and others. */

/* < https://opensource.org/licenses/BSD-3-Clause > */

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#include "../../m_spaghettis.h"
#include "../../m_core.h"

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

PD_LOCAL int main_start (void);

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

extern int  main_argc;

extern char **main_argv;

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

#if PD_WITH_DEBUG

PD_LOCAL int sys_isControlThread (void)
{
    #if defined ( PD_BUILDING_APPLICATION ) || defined ( PD_BUILDING_TERMINAL )
    
    static pthread_t main; static int once = 0;
    
    pthread_t t = pthread_self();
    
    if (!once) { once = 1; main = t; return 1; }

    return (pthread_equal (main, t) != 0);
    
    #else
    
    return 0;
    
    #endif
}

#endif // PD_WITH_DEBUG

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

static_assert (sizeof (int) >= 4, "");      /* Just in case. */

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

#if defined ( PD_BUILDING_TERMINAL )

PD_EXPORT int main (int argc, char **argv)
{
    main_argc = argc;
    main_argv = argv;
    
    PD_ASSERT (sys_isControlThread()); return main_start();
}

#endif

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
