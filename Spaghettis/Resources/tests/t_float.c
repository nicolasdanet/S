
/* < https://opensource.org/licenses/BSD-3-Clause > */

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#include "t_randomMT64.h"

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

static int test_floatFailed;

static t_float64Atomic  test_float64Shared;
static double           test_doubleShared;

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

#define TEST_FLOAT_LOOP     10000000

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

double test_floatGet (void)
{
    static uint64_t i = 0;
    
    return test_genrand64_real2[(++i) % 1000];
}

int test_floatIsValid (double f)
{
    int i; for (i = 0; i < 1000; i++) { if (f == test_genrand64_real2[i]) { return 1; } }
    
    return 0;
}

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
// MARK: -

void *test_float (void *x)
{
    int i, n = (int)(long)x;
    
    TTTWaste w;
    
    ttt_wasteInit (&w, n);
    
    if ((n % 2) == 0) {
        
        for (i = 0; i < TEST_FLOAT_LOOP; i++) {
        //
        double f = test_floatGet();
        
        PD_ATOMIC_FLOAT64_WRITE (f, &test_float64Shared);
        // test_doubleShared = f;
        
        PD_MEMORY_BARRIER;      /* Prevent hoisting the store out of the loop. */
        
        ttt_wasteTime (&w);
        //
        }

    } else {
    
        for (i = 0; i < TEST_FLOAT_LOOP; i++) {
        //
        PD_MEMORY_BARRIER;      /* Prevent hoisting the load out of the loop. */
        
        double f = PD_ATOMIC_FLOAT64_READ (&test_float64Shared);
        // double f = test_doubleShared;
        
        if (!test_floatIsValid (f)) { test_floatFailed = 1; }
        
        ttt_wasteTime (&w);
        //
        }
    }

    return NULL;
}

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#if 0
void test13__float() {    /* Read / Write. */
#endif

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

TTT_BEGIN (AtomicFloat, 13, "Atomic - Float")

    TTT_EXPECT (sizeof (t_float64Atomic) == 8);
    TTT_EXPECT (sizeof (double) == sizeof (uint64_t));
    TTT_EXPECT (sizeof (double) == sizeof (t_float64Atomic));
    
    PD_ATOMIC_FLOAT64_WRITE (test_floatGet(), &test_float64Shared);
    
    if (ttt_testThreadsLaunch (test_float) != TTT_GOOD) { TTT_FAIL; }
    else {
        TTT_EXPECT (test_floatFailed == 0);
    }

TTT_END

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------

#if 0
}
#endif

// -----------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------
